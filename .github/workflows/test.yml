name: smart-contract-ci

on:
  push:
  pull_request:
  workflow_dispatch:

env:
  FOUNDRY_PROFILE: smart-contract-ci

jobs:
  check:
    name: Foundry project
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1

      - name: Show Forge version
        run: |
          forge --version

      - name: Run Forge fmt
        run: |
          forge fmt --check
        id: fmt

      - name: Run Forge build
        run: |
          forge build --sizes
        id: build

      - name: Run Forge tests
        run: |
          forge test -vvv
        id: test

      - name: Get Commit Messages
        id: get_commits
        run: |
          if [ "${{ github.event_name }}" == "push" ]; then
            COMMITS=$(echo '${{ toJSON(github.event.commits) }}' | jq -r '.[] | "- " + (.message | split("\n")[0])')
          else
            COMMITS="Manual Trigger / Not a push event"
          fi
          echo "COMMITS<<EOF" >> $GITHUB_ENV
          echo "$COMMITS" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
      - name: Notify Telegram (Success)
        if: success()
        run: |
          TEXT=$(cat <<'EOF'
          âœ… *Smart Contract Test Success!*
          
          Repository: ${{ github.repository }}
          Branch: ${{ github.ref_name }}
          By: ${{ github.actor }}
          
          *Commits:*
          ${{ env.COMMITS }}
          
          ðŸ§© [View Workflow Logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          EOF
          )
          TEXT_URLENCODED=$(echo "$TEXT" | jq -s -R -r @uri)
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d message_thread_id="${{ secrets.TELEGRAM_TOPIC_ID }}" \
            -d text="$TEXT_URLENCODED" \
            -d parse_mode="Markdown"

      - name: Notify Telegram (Failed)
        if: failure()
        run: |
          TEXT=$(cat <<'EOF'
          âŒ *Smart Contract Test Failed!*
          
          Repository: ${{ github.repository }}
          Branch: ${{ github.ref_name }}
          By: ${{ github.actor }}

          *Commits:*
          ${{ env.COMMITS }}
          
          ðŸ§© [View Workflow Logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          EOF
          )
          TEXT_URLENCODED=$(echo "$TEXT" | jq -s -R -r @uri)
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d message_thread_id="${{ secrets.TELEGRAM_TOPIC_ID }}" \
            -d text="$TEXT_URLENCODED" \
            -d parse_mode="Markdown"
